<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博物馆智慧管理系统 - 文物管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
            transform: translateY(-2px);
        }

        .content-area {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,\n        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 500;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .qr-scanner {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }

        .qr-scanner:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .device-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .main-nav {
                gap: 10px;
            }

            .nav-btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .content-area {
                padding: 20px;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 身份选择界面 -->
    <div id="roleSelectionArea" style="text-align: center; padding-top: 100px;">
        <h1>请选择您的身份</h1>
        <div style="margin-top: 30px;">
            <button class="btn btn-secondary" onclick="selectRole('Normal')">普通用户</button>
            <button class="btn btn-secondary" onclick="selectRole('Admin')">管理员</button>
        </div>
    </div>

    <!-- 主界面 ( initially hidden ) -->
    <div id="mainContentArea" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>🏛️ 博物馆智慧管理系统</h1>
                <p>Museum Smart Management System - MVP版本</p>
                <!-- 添加回显示当前角色的 span -->
                <span id="currentRoleDisplay" style="margin-left: 20px; color: #333;">当前角色: 未设置</span>
                <!-- 新增：重新选择身份按钮 -->
                 <button class="btn btn-secondary btn-sm" onclick="resetRoleSelection()" style="margin-left: 20px;">重新选择身份</button>
            </div>

            <!-- 原有的模拟用户身份控制区域已经转移到身份选择界面 -->
            <!-- <div style="text-align: center; margin-bottom: 20px;"> ... </div> -->

            <div class="main-nav">
                <button class="nav-btn active" data-target="overview">首页概览</button>
                <!-- 观众端导航按钮，根据实际情况添加或修改 -->
                <button class="nav-btn" data-target="artifact-info">文物信息</button>
                <button class="nav-btn" data-target="multimedia-interaction">多媒体互动</button>
                <button class="nav-btn" data-target="community">互动社区</button>
                <button class="nav-btn" data-target="ai-qa">AI问答</button>
                <!-- 管理端导航按钮 -->
                <button class="nav-btn" data-target="artifact-management">文物管理</button>
                <button class="nav-btn" data-target="device-management">设备管理</button>
                <button class="nav-btn" data-target="activity-management">活动管理</button>
                <button class="nav-btn" data-target="exhibition-hall-management">展厅管理</button>
                <button class="nav-btn" data-target="user-management">用户管理</button>
                <button class="nav-btn" data-target="data-dashboard">数据看板</button>
            </div>

            <div class="content-area">
                 <!-- 首页概览 Section (示例) -->
                 <section id="overview" class="section active">
                     <h2>📊 数据总览</h2>
                     <div class="stats-grid">
                         <div class="stat-card">
                             <h3 id="totalArtifacts">0</h3>
                             <p>文物总数</p>
                         </div>
                         <div class="stat-card">
                             <h3 id="onlineDevices">0</h3>
                             <p>在线设备</p>
                         </div>
                         <div class="stat-card">
                             <h3 id="todayVisitors">0</h3>
                             <p>今日访客</p>
                         </div>
                         <div class="stat-card">
                             <h3 id="activeEvents">0</h3>
                             <p>进行中活动</p>
                         </div>
                     </div>

                     <div class="card-grid">
                         <div class="card">
                             <h3>🏺 热门文物</h3>
                             <table class="data-table">
                                 <thead>
                                     <tr>
                                         <th>文物名称</th>
                                         <th>浏览次数</th>
                                     </tr>
                                 </thead>
                                 <tbody id="popularArtifactsTableBody">
                                     <!-- 动态加载内容 -->
                                     <tr><td>加载中...</td><td></td></tr>
                                 </tbody>
                             </table>
                         </div>
                         <div class="card">
                             <h3>⚠️ 设备告警</h3>
                             <div id="deviceAlerts">
                                  <!-- 动态加载内容 -->
                                  <p style="color: #28a745;">✅ 所有设备运行正常</p> <!-- Default static message -->
                             </div>
                         </div>
                         <!-- 新增：最新活动卡片 -->
                         <div class="card">
                              <h3>✨ 最新活动</h3>
                              <div id="latestActivitiesList">
                                  <!-- 最新活动列表将由JavaScript动态加载到这里 -->
                                  <p>加载中...</p>
                              </div>
                         </div>
                     </div>

                     <div class="qr-scanner">
                         <h3>📸 扫描二维码</h3>
                         <p>请使用移动设备扫描二维码进行访问。</p>
                         <!-- 二维码显示区域 -->
                         <div id="qrcode" style="margin: 20px auto; width: 150px; height: 150px;"></div>
                         <button class="btn btn-secondary" onclick="simulateQRScan()">模拟扫描</button>
                     </div>
                 </section>

                 <!-- 观众端 Sections (示例) -->
                 <section id="artifact-info" class="section">
                     <h2>文物信息与导览</h2>
                     <p>浏览我们的文物收藏。</p>
                     <!-- 文物展示区域 -->
                      <div class="artifact-list-audience" id="audienceArtifactList">
                         <!-- 文物卡片或列表将由JavaScript动态加载到这里 -->
                          <p>加载中...</p> <!-- 初始加载提示 -->
                     </div>
                     <!-- 文物详情展示区域 (初始隐藏) -->
                      <section id="artifact-details" class="section" style="display: none;">
                         <!-- 单个文物详情将由JavaScript加载到这里 -->
                      </section>
                 </section>

                 <section id="multimedia-interaction" class="section">
                     <h2>多媒体互动</h2>
                     <p>探索丰富的多媒体内容，包括文物音视频和展厅全景。</p>

                     <!-- 全景展厅区域 -->
                      <div class="card" style="margin-bottom: 20px;">
                         <h3>🌍 展厅全景</h3>
                          <div id="panoramaView">
                              <p>加载中...</p>
                              <!-- 全景视图将加载到这里 -->
                         </div>
                     </div>

                     <!-- 带有媒体的文物列表区域 -->
                     <div class="card">
                         <h3>▶️ 媒体文物列表</h3>
                          <div id="multimediaArtifactList">
                              <!-- 带有音频或视频的文物列表将由JavaScript动态加载到这里 -->
                              <p>加载中...</p>
                         </div>
                     </div>
                 </section>

                 <section id="community" class="section">
                     <h2>互动社区</h2>
                     <p>在这里分享您的参观体验和心得。</p>

                     <!-- 分享心得表单区域 -->
                      <div class="card" style="margin-bottom: 20px;">
                         <h3>✏️ 分享我的心得</h3>
                          <form id="shareExperienceForm">
                             <div class="form-group">
                                  <label for="experienceContent">我的心得:</label>
                                 <textarea id="experienceContent" rows="4" required placeholder="写下您的参观感受..."></textarea>
                              </div>
                              <!-- 可选：关联文物 -->
                              <div class="form-group">
                                  <label for="experienceArtifact">关联文物 (可选):</label>
                                  <select id="experienceArtifact">
                                      <option value="">-- 选择文物 --</option>
                                      <!-- 文物列表将由JavaScript填充 -->
                                 </select>
                              </div>
                              <!-- TODO: 如果有用户登录功能，这里需要传递用户ID -->
                              <button type="submit" class="btn">提交心得</button>
                          </form>
                     </div>

                     <!-- 用户心得列表区域 -->
                      <div class="card">
                         <h3>💬 大家的心得</h3>
                          <div id="communityPostsList">
                              <!-- 用户心得将由JavaScript动态加载到这里 -->
                              <p>加载中...</p>
                          </div>
                     </div>
                 </section>

                 <section id="ai-qa" class="section">
                     <h2>AI问答</h2>
                     <p>在此您可以提交问题，或查看其他用户的公开问答和智能解答。</p>

                     <!-- 提问表单 -->
                      <div class="card" style="margin-bottom: 20px;">
                         <h3>提问</h3>
                          <form id="askQuestionForm">
                             <div class="form-group">
                                 <label for="questionText">您的问题:</label>
                                 <textarea id="questionText" rows="4" required placeholder="请输入您关于博物馆或文物的疑问..."></textarea>
                             </div>
                              <!-- 如果问题是针对特定文物的，可以选择关联文物 -->
                              <div class="form-group">
                                  <label for="questionArtifact">关联文物 (可选):</label>
                                  <select id="questionArtifact">
                                      <option value="">-- 选择文物 --</option>
                                      <!-- 文物列表将由JavaScript填充 -->
                                  </select>
                              </div>
                              <button type="submit" class="btn">提交问题</button>
                          </form>
                     </div>

                      <!-- 问答列表区域 -->
                      <div class="card">
                         <h3>公开问答列表</h3>
                          <div id="qaList">
                              <!-- 问答数据将由JavaScript动态加载到这里 -->
                              <p>加载中...</p>
                         </div>
                     </div>
                 </section>

                 <!-- 管理端 Sections -->
                 <section id="artifact-management" class="section">
                     <h2>文物管理</h2>
                     <p>此区域用于文物的信息录入、批量导入及图像识别辅助建档等操作。</p>
                     <!-- TODO: 在此添加文物管理的表单、表格等具体HTML元素 -->

                     <!-- 文物添加/编辑表单区域 -->
                     <div class="card" style="margin-bottom: 20px;">
                         <h3>📝 添加新文物</h3>
                         <form id="addArtifactForm">
                             <div class="form-group">
                                 <label for="artifactName">名称:</label>
                                 <input type="text" id="artifactName" required placeholder="例：唐三彩马俑">
                             </div>
                             <div class="form-group">
                                 <label for="artifactCategory">分类:</label>
                                 <input type="text" id="artifactCategory" placeholder="例：陶瓷">
                             </div>
                              <div class="form-group">
                                 <label for="artifactEra">年代:</label>
                                 <input type="text" id="artifactEra" placeholder="例：唐代">
                              </div>
                             <div class="form-group">
                                 <label for="artifactLocation">位置:</label>
                                  <input type="text" id="artifactLocation" placeholder="例：古代文明厅">
                             </div>
                             <div class="form-group">
                                 <label for="artifactDescription">描述:</label>
                                 <textarea id="artifactDescription" rows="3" placeholder="请输入文物详细描述..."></textarea>
                             </div>
                             <div class="form-group">
                                  <label for="artifactImageUrl">图片URL:</label>
                                  <input type="url" id="artifactImageUrl" placeholder="例：http://example.com/img/artifact1.jpg">
                               </div>
                               <div class="form-group">
                                  <label for="artifactImageFile">或上传图片:</label>
                                  <input type="file" id="artifactImageFile" accept="image/*">
                               </div>
                             <div class="form-group">
                                 <label for="artifactAudioUrl">音频URL:</label>
                                 <input type="url" id="artifactAudioUrl" placeholder="例：http://example.com/audio/artifact1.mp3">
                              </div>
                              <div class="form-group">
                                  <label for="artifactAudioFile">或上传音频:</label>
                                  <input type="file" id="artifactAudioFile" accept="audio/*">
                              </div>
                             <div class="form-group">
                                 <label for="artifactVideoUrl">视频URL:</label>
                                 <input type="url" id="artifactVideoUrl" placeholder="例：http://example.com/video/artifact1.mp4">
                              </div>
                              <div class="form-group">
                                 <label for="artifactFeatureTags">特征标签 (逗号分隔):</label>
                                 <input type="text" id="artifactFeatureTags" placeholder="例：马, 唐代, 陶瓷">
                              </div>
                              <!-- 对于view_count, interact_count, is_hot, is_new, create_time, update_time这些字段，
                                   通常在后端处理或有默认值，前端录入时可能不需要，或者只需要is_hot, is_new的checkbox -->
                              <div class="form-group">
                                   <input type="checkbox" id="artifactIsHot"> <label for="artifactIsHot">热门</label>
                              </div>
                              <div class="form-group">
                                   <input type="checkbox" id="artifactIsNew"> <label for="artifactIsNew">新入藏</label>
                              </div>


                             <button type="submit" class="btn">添加文物</button>
                         </form>
                     </div>

                     <!-- 文物列表区域 -->
                     <div class="card" style="margin-top: 20px;">
                         <h3>📋 文物列表</h3>
                         <table class="data-table" id="artifactsTable">
                             <thead>
                                 <tr>
                                     <th>编号</th>
                                     <th>名称</th>
                                     <th>分类</th>
                                     <th>年代</th>
                                     <th>位置</th>
                                     <th>浏览次数</th>
                                     <th>热门</th>
                                     <th>新入藏</th>
                                     <th>操作</th>
                                 </tr>
                             </thead>
                             <tbody id="artifactsTableBody">
                                 <!-- 文物数据将由JavaScript动态加载到这里 -->
                                 <tr><td colspan="9">加载中...</td></tr> <!-- 初始加载提示 -->
                             </tbody>
                         </table>
                     </div>

                 </section>

                 <section id="device-management" class="section">
                     <h2>📡 设备监控</h2>
                     <p>此区域用于设备的实时状态监控、数据图表展示及故障预警配置。</p>
                     <!-- TODO: 在此添加设备状态展示、图表区域等具体HTML元素 -->

                      <!-- 环境监控/人流监控卡片 (保留或根据需要修改) -->
                      <div class="card-grid" style="margin-bottom: 20px;">
                          <div class="card">
                              <h3>🌡️ 环境监控</h3>
                              <div class="stats-grid">
                                  <div class="stat-card">
                                      <h3 id="temperature">--°C</h3>
                                      <p>温度</p>
                                  </div>
                                  <div class="stat-card">
                                      <h3 id="humidity">--%</h3>
                                      <p>湿度</p>
                                  </div>
                              </div>
                          </div>
                          <div class="card">
                              <h3>👥 人流监控</h3>
                              <div class="stats-grid">
                                  <div class="stat-card">
                                      <h3 id="currentVisitors">--</h3>
                                      <p>当前在馆人数</p>
                                  </div>
                                  <div class="stat-card">
                                      <h3 id="peakTime">--:--</h3>
                                      <p>今日高峰时段</p>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- 设备状态列表区域 -->
                      <div class="card">
                         <h3>🔧 设备状态列表</h3>
                          <table class="data-table" id="devicesTable">
                             <thead>
                                 <tr>
                                     <th>ID</th>
                                     <th>设备ID</th>
                                     <th>类型</th>
                                     <th>位置</th>
                                     <th>状态</th>
                                     <th>值</th>
                                      <th>电量 (%)</th>
                                      <th>告警级别</th>
                                     <th>告警信息</th>
                                     <th>更新时间</th>
                                 </tr>
                             </thead>
                             <tbody id="devicesTableBody">
                                 <!-- 设备数据将由JavaScript动态加载到这里 -->
                                 <tr><td colspan="10">加载中...</td></tr> <!-- 初始加载提示 -->
                             </tbody>
                         </table>
                     </div>

                 </section>

                 <section id="activity-management" class="section">
                     <h2>🎉 活动管理</h2>
                     <p>此区域用于活动的策划发布、用户报名管理及用户画像分析。</p>
                     <!-- TODO: 在此添加活动发布表单、活动列表、参与者列表等具体HTML元素 -->

                     <!-- 活动添加/编辑表单区域 -->
                     <div class="card" style="margin-bottom: 20px;">
                         <h3>📝 添加新活动</h3>
                         <form id="addActivityForm">
                             <div class="form-group">
                                 <label for="activityTitle">标题:</label>
                                 <input type="text" id="activityTitle" required placeholder="例：文物知识讲座">
                             </div>
                             <div class="form-group">
                                 <label for="activityType">类型:</label>
                                 <input type="text" id="activityType" placeholder="例：workshop/exhibition/talk">
                             </div>
                             <div class="form-group">
                                 <label for="activityStartTime">开始时间:</label>
                                 <input type="datetime-local" id="activityStartTime" required>
                             </div>
                             <div class="form-group">
                                 <label for="activityEndTime">结束时间:</label>
                                 <input type="datetime-local" id="activityEndTime">
                             </div>
                             <div class="form-group">
                                 <label for="activityLocation">地点:</label>
                                 <input type="text" id="activityLocation" placeholder="例：多功能厅A">
                             </div>
                             <div class="form-group">
                                 <label for="activityDescription">描述:</label>
                                 <textarea id="activityDescription" rows="3" placeholder="请输入活动详细描述..."></textarea>
                             </div>
                             <div class="form-group">
                                 <label for="activityImageUrl">图片URL:</label>
                                 <input type="url" id="activityImageUrl" placeholder="例：http://example.com/img/activity1.jpg">
                             </div>
                             <div class="form-group">
                                 <label for="activityImageFile">或上传图片:</label>
                                 <input type="file" id="activityImageFile" accept="image/*">
                             </div>
                             <div class="form-group">
                                 <label for="activityMaxParticipants">最大参与人数:</label>
                                 <input type="number" id="activityMaxParticipants" placeholder="例：100">
                             </div>
                             <div class="form-group">
                                  <input type="checkbox" id="activityIsPublished"> <label for="activityIsPublished">是否发布</label>
                             </div>

                             <button type="submit" class="btn">添加活动</button>
                         </form>
                     </div>

                     <!-- 活动列表区域 -->
                     <div class="card">
                         <h3>📅 活动列表</h3>
                          <table class="data-table" id="activitiesTable">
                             <thead>
                                 <tr>
                                     <th>ID</th>
                                     <th>标题</th>
                                     <th>类型</th>
                                     <th>开始时间</th>
                                     <th>结束时间</th>
                                     <th>地点</th>
                                      <th>最大人数</th>
                                     <th>当前人数</th>
                                     <th>已发布</th>
                                     <th>操作</th>
                                 </tr>
                             </thead>
                             <tbody id="activitiesTableBody">
                                 <!-- 活动数据将由JavaScript动态加载到这里 -->
                                 <tr><td colspan="10">加载中...</td></tr> <!-- 初始加载提示 -->
                             </tbody>
                         </table>
                     </div>

                 </section>

                 <section id="data-dashboard" class="section">
                     <h2>数据看板</h2>
                     <p>此区域用于展示观众行为数据统计，如导览停留时长、互动频率等。</p>
                     <!-- TODO: 在此添加数据图表、统计表格等具体HTML元素 -->

                      <!-- 用户行为数据列表区域 -->
                      <div class="card" style="margin-top: 20px;">
                         <h3>📊 用户行为记录</h3>
                          <table class="data-table" id="userBehaviorsTable">
                             <thead>
                                 <tr>
                                     <th>ID</th>
                                     <th>用户ID</th>
                                     <th>文物ID</th>
                                     <th>行为类型</th>
                                     <th>时长 (秒)</th>
                                     <th>内容</th>
                                     <th>位置</th>
                                     <th>时间</th>
                                 </tr>
                             </thead>
                             <tbody id="userBehaviorsTableBody">
                                 <!-- 用户行为数据将由JavaScript动态加载到这里 -->
                                 <tr><td colspan="8">加载中...</td></tr> <!-- 初始加载提示 -->
                             </tbody>
                         </table>
                     </div>
                 </section>

                 <!-- 管理端 Sections - 展厅管理 -->
                 <section id="exhibition-hall-management" class="section">
                     <h2>🏛️ 展厅管理</h2>
                     <p>此区域用于展厅信息的管理，包括名称、楼层、区域码等。</p>

                     <!-- 展厅添加/编辑表单区域 -->
                     <div class="card" style="margin-bottom: 20px;">
                         <h3>📝 添加新展厅</h3>
                         <form id="addExhibitionHallForm">
                             <div class="form-group">
                                 <label for="hallName">名称:</label>
                                 <input type="text" id="hallName" required placeholder="例：古代文明厅">
                             </div>
                              <div class="form-group">
                                 <label for="hallFloor">楼层:</label>
                                 <input type="text" id="hallFloor" placeholder="例：1F">
                              </div>
                             <div class="form-group">
                                 <label for="hallAreaCode">区域码:</label>
                                 <input type="text" id="hallAreaCode" placeholder="例：A区">
                             </div>
                             <div class="form-group">
                                 <label for="hallDescription">描述:</label>
                                 <textarea id="hallDescription" rows="3" placeholder="请输入展厅描述..."></textarea>
                             </div>
                             <div class="form-group">
                                 <label for="hallPanoramaURL">全景URL:</label>
                                 <input type="url" id="hallPanoramaURL" placeholder="例：http://example.com/panorama/hall1.jpg">
                              </div>
                              <div class="form-group">
                                 <label for="hallSequence">排序:</label>
                                 <input type="number" id="hallSequence" placeholder="例：1">
                              </div>
                              <!-- ArtifactCount, CreateTime 通常由后端处理或不需要前端提交 -->

                             <button type="submit" class="btn">添加展厅</button>
                         </form>
                     </div>

                      <!-- 展厅列表区域 -->
                      <div class="card">
                         <h3>📋 展厅列表</h3>
                         <table class="data-table" id="exhibitionHallsTable">
                             <thead>
                                 <tr>
                                     <th>ID</th>
                                     <th>名称</th>
                                     <th>楼层</th>
                                     <th>区域码</th>
                                     <th>文物数量</th>
                                     <th>操作</th>
                                 </tr>
                             </thead>
                             <tbody id="exhibitionHallsTableBody">
                                 <!-- 展厅数据将由JavaScript动态加载到这里 -->
                                 <tr><td colspan="6">加载中...</td></tr> <!-- 初始加载提示 -->
                             </tbody>
                         </table>
                     </div>
                 </section>

                 <!-- 用户管理 Section -->
                 <section id="user-management" class="section">
                     <h2>👥 用户管理</h2>
                     <p>此区域用于展示用户列表、添加新用户等操作。</p>
                     <!-- TODO: 在此添加用户管理相关的表单、表格等具体HTML元素 -->

                     <!-- 用户列表区域 -->
                     <div class="card" style="margin-top: 20px;">
                         <h3>📋 用户列表</h3>
                         <table class="data-table" id="usersTable">
                             <thead>
                                 <tr>
                                     <th>ID</th>
                                     <th>OpenID</th>
                                     <th>昵称</th>
                                     <th>头像</th>
                                     <th>性别</th>
                                     <th>年龄段</th>
                                     <th>访问次数</th>
                                     <th>收藏次数</th>
                                     <th>角色</th>
                                     <th>创建时间</th>
                                     <th>最后登录时间</th>
                                     <th>操作</th>
                                 </tr>
                             </thead>
                             <tbody id="usersTableBody">
                                 <!-- 用户数据将由JavaScript动态加载到这里 -->
                                 <tr><td colspan="11">加载中...</td></tr> <!-- 初始加载提示 -->
                             </tbody>
                         </table>
                     </div>

                     <!-- 用户添加表单区域 -->
                     <div class="card" style="margin-bottom: 20px;">
                         <h3>📝 添加新用户</h3>
                         <form id="addUserForm">
                             <div class="form-group">
                                 <label for="userOpenID">OpenID:</label>
                                 <input type="text" id="userOpenID" required placeholder="请输入用户OpenID">
                             </div>
                             <div class="form-group">
                                 <label for="userNickname">昵称:</label>
                                 <input type="text" id="userNickname" placeholder="请输入用户昵称">
                             </div>
                             <div class="form-group">
                                 <label for="userAvatarURL">头像URL:</label>
                                 <input type="url" id="userAvatarURL" placeholder="请输入头像图片URL">
                             </div>
                             <div class="form-group">
                                 <label for="userGender">性别:</label>
                                 <select id="userGender">
                                     <option value="">-- 选择性别 --</option>
                                     <option value="Male">男</option>
                                     <option value="Female">女</option>
                                     <option value="Other">其他</option>
                                     <option value="Unknown">未知</option>
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label for="userAgeGroup">年龄段:</label>
                                  <input type="text" id="userAgeGroup" placeholder="例：20-29">
                              </div>
                             <div class="form-group">
                                 <label for="userRole">角色:</label>
                                 <select id="userRole" required>
                                      <option value="">-- 选择角色 --</option>
                                      <option value="Normal">普通用户</option>
                                      <option value="Admin">管理员</option>
                                  </select>
                              </div>

                             <button type="submit" class="btn">添加用户</button>
                         </form>
                     </div>

                 </section>
             </div>
         </div>
     </div>

    <script>
        // Store loaded artifacts for searching
        window.currentArtifacts = [];

        // Store the ID of the artifact being edited (null when adding new)
        window.editingArtifactId = null;

        // Store loaded activities
        window.currentActivities = []; // 新增：存储加载的活动数据
        window.editingActivityId = null; // 新增：存储正在编辑的活动ID

        // Store loaded exhibition halls
        window.currentExhibitionHalls = [];

        // Store loaded users
        window.currentUsers = [];

        // Store the ID of the user being edited (null when adding new)
        window.editingUserId = null;

        // Global variable to store current user role
        window.currentUserRole = null; // 'Normal' or 'Admin'

        // Function to show selected section
        async function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            } else {
                 console.error('Section not found:', sectionId);
                 // Optionally, default to overview or show an error message on the page
                 document.getElementById('overview').classList.add('active');
            }


            // Update active navigation button
            const navBtns = document.querySelectorAll('.main-nav .nav-btn');
            navBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.main-nav .nav-btn[data-target='${sectionId}']`);
            if (activeBtn) {
               activeBtn.classList.add('active');
            }


            // Load data for the selected section
            if (sectionId === 'artifact-management') {
                 await loadArtifacts(); // Make sure artifacts are loaded
                 displayArtifacts(window.currentArtifacts); // Display in management table
             } else if (sectionId === 'artifact-info') {
                 await loadArtifacts(); // Load artifacts for audience view
                 displayArtifactsForAudience(window.currentArtifacts); // Display in audience view
              } else if (sectionId === 'overview') {
                  await loadOverviewData(); // Placeholder for loading overview data
              } else if (sectionId === 'multimedia-interaction') {
                  await loadArtifacts(); // Load artifacts (for multimedia links)
                  await loadExhibitionHallData(); // Load exhibition halls (for panorama links)
                  displayMultimediaContent(window.currentArtifacts, window.currentExhibitionHalls); // Display multimedia content
              } else if (sectionId === 'device-management') {
                  await loadDeviceData(); // 调用加载设备数据的函数
              } else if (sectionId === 'community') {
                  // Load artifacts for the related artifact dropdown
                  if (!window.currentArtifacts || window.currentArtifacts.length === 0) {
                      await loadArtifacts();
                  }
                  loadArtifactOptionsForCommunity(); // Populate artifact dropdown for community form
                  await loadUserBehaviorData(); // Load user behaviors
                  // displayCommunityPosts is called within loadUserBehaviorData now
              } else if (sectionId === 'activity-management') {
                  await loadActivityData(); // 调用加载活动数据的函数
              } else if (sectionId === 'data-dashboard') {
                  loadVisitorData(); // Placeholder
                  await loadUserBehaviorData(); // Load user behaviors for the dashboard
                  // displayUserBehaviorData is called within loadUserBehaviorData
              } else if (sectionId === 'exhibition-hall-management') {
                  await loadExhibitionHallData(); // 调用加载展厅数据的函数
              } else if (sectionId === 'ai-qa') {
                  // Ensure artifacts are loaded before populating the dropdown
                  if (!window.currentArtifacts || window.currentArtifacts.length === 0) {
                      await loadArtifacts(); // Load artifacts if not already loaded
                  }
                  loadQAData(); // Load QA data
                  loadArtifactOptionsForQA(); // Populate artifact dropdown
              } else if (sectionId === 'user-management') {
                  await loadUserData(); // 调用加载用户数据的函数
              }
        }

        // Function to load overview data (placeholder)
        async function loadOverviewData() {
            console.log("Loading overview data...");
            // Call existing functions to load data
            await loadArtifacts();
            await loadDeviceData();
            await loadActivityData(); // Load activities
            await loadUserBehaviorData(); // Assuming user behavior data includes visitor info

            // After data is loaded, update overview sections
             updateOverviewStats(); // Update stats based on loaded data
             loadPopularArtifactsTable(); // Update popular artifacts table
             loadDeviceAlerts(); // Update device alerts
             displayLatestActivities(); // Display latest activities (New Call)
        }

         function updateOverviewStats() {
             console.log("Updating overview stats...");
              // Update total artifacts count based on loaded artifacts
              document.getElementById('totalArtifacts').textContent = window.currentArtifacts ? window.currentArtifacts.length : 0;
              // Update online devices based on loaded devices
              const onlineDevices = window.currentDevices ? window.currentDevices.filter(device => device.Status === '在线').length : 0;
              document.getElementById('onlineDevices').textContent = onlineDevices;

              // Update active events based on loaded activities
              // Assuming activities have a status or check start/end time
              const now = new Date();
              const activeEvents = window.currentActivities ? window.currentActivities.filter(activity => {
                  const startTime = new Date(activity.StartTime);
                  const endTime = activity.EndTime ? new Date(activity.EndTime) : null;
                  return startTime <= now && (!endTime || endTime >= now);
              }).length : 0;
              document.getElementById('activeEvents').textContent = activeEvents;

              // Update today's visitors (This is a placeholder, requires specific user behavior data)
              // You would need to filter user behavior data for today's visits if available
              // For now, it remains a placeholder or uses a simple count from user data if available
              // const todayVisitors = window.currentUserBehaviors ? window.currentUserBehaviors.filter(...).length : 0; // Example logic
              // If you have a user count in userData:
              const totalUsers = window.currentUsers ? window.currentUsers.length : 0;
               document.getElementById('todayVisitors').textContent = totalUsers; // Using total users as a placeholder for now
         }

         function loadPopularArtifactsTable() {
             console.log("Loading popular artifacts table...");
              const popularArtifactsTableBody = document.getElementById('popularArtifactsTableBody');
               if (popularArtifactsTableBody) {
                   popularArtifactsTableBody.innerHTML = ''; // Clear previous
                   const artifacts = window.currentArtifacts || [];

                   if (artifacts.length === 0) {
                       popularArtifactsTableBody.innerHTML = '<tr><td colspan="2">暂无热门文物数据。</td></tr>';
                       return;
                   }

                   // Sort artifacts by ViewCount in descending order
                   const sortedArtifacts = [...artifacts].sort((a, b) => (b.ViewCount || 0) - (a.ViewCount || 0));

                   // Display top N popular artifacts (e.g., top 5)
                   const topN = 5;
                   sortedArtifacts.slice(0, topN).forEach(artifact => {
                       const row = document.createElement('tr');
                       row.innerHTML = `<tr><td>${artifact.Name || '未知'}</td><td>${artifact.ViewCount || 0}</td></tr>`;
                       popularArtifactsTableBody.appendChild(row);
                   });
               }
         }

         function loadDeviceAlerts() {
             console.log("Loading device alerts...");
              const deviceAlertsDiv = document.getElementById('deviceAlerts');
              if (deviceAlertsDiv) {
                   deviceAlertsDiv.innerHTML = ''; // Clear previous
                   const devices = window.currentDevices || [];

                   // Filter devices with high or medium alert level or Status is '告警'
                   const alertingDevices = devices.filter(device => 
                       device.AlertLevel === 'High' || device.AlertLevel === 'Medium' || device.Status === '告警'
                   );

                   if (alertingDevices.length === 0) {
                       deviceAlertsDiv.innerHTML = '<p style="color: #28a745;">✅ 所有设备运行正常</p>';
                   } else {
                       const alertList = document.createElement('ul');
                       alertList.style.listStyle = 'none';
                       alertList.style.padding = '0';
                       alertingDevices.forEach(device => {
                           const listItem = document.createElement('li');
                           listItem.style.color = '#dc3545'; // Red color for alerts
                           listItem.innerHTML = `<strong>设备ID: ${device.DeviceID || '未知'}</strong> (${device.DeviceType || '未知'}): ${device.AlertMessage || '无告警信息'} (级别: ${device.AlertLevel || '未知'})`;
                           alertList.appendChild(listItem);
                       });
                       deviceAlertsDiv.appendChild(alertList);
                   }
               }
         }

        // Function to load artifacts from the backend API
        async function loadArtifacts() {
            const artifactsTableBody = document.getElementById('artifactsTableBody');
            // Check if artifactsTableBody exists before trying to update it
            if (!artifactsTableBody) {
                console.error('Artifacts table body not found.');
                return;
            }
            artifactsTableBody.innerHTML = '<tr><td colspan="9">加载中...</td></tr>'; // Loading indicator

            try {
                const response = await fetch('http://192.168.31.201:5000/api/artifacts');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const artifacts = await response.json();

                // Store artifacts data globally or in a way accessible to search
                window.currentArtifacts = artifacts; // Store for searching

                displayArtifacts(artifacts); // Display all loaded artifacts initially

                 // Update total artifacts count in overview if overview section exists
                 const totalArtifactsElement = document.getElementById('totalArtifacts');
                 if(totalArtifactsElement) {
                     totalArtifactsElement.textContent = artifacts.length;
                 }


            } catch (error) {
                console.error('Error loading artifacts:', error);
                if (artifactsTableBody) {
                     artifactsTableBody.innerHTML = `<tr><td colspan="9" style="color: red;">加载文物数据失败: ${error.message}</td></tr>`;
                }
                 // Update total artifacts count to indicate error or zero
                 const totalArtifactsElement = document.getElementById('totalArtifacts');
                 if(totalArtifactsElement) {
                     totalArtifactsElement.textContent = 'Error'; // Or '0' or '-'
                 }
            }
        }

        // Function to display artifacts in the table
        function displayArtifacts(artifactsToDisplay) {
             const artifactsTableBody = document.getElementById('artifactsTableBody');
              // Check if artifactsTableBody exists before trying to update it
            if (!artifactsTableBody) {
                console.error('Artifacts table body not found for display.');
                return;
            }
             artifactsTableBody.innerHTML = ''; // Clear previous entries

             if (artifactsToDisplay.length === 0) {
                 artifactsTableBody.innerHTML = '<tr><td colspan="9">暂无文物数据。</td></tr>'; // 更新colspan
                 return;
             }

             // Mapping for location values to display text
             const locationMap = {
                 'ancient': '古代文明厅',
                 'ceramic': '陶瓷艺术厅',
                 'bronze': '青铜器厅',
                 'calligraphy': '字画厅',
                 // Add other mappings if you have more locations from your database
                 '': '未知展厅' // Handle empty or null location from database
             };

             artifactsToDisplay.forEach(artifact => {
                 const row = document.createElement('tr');
                 // Get the display text for the location, default to the stored value if not found in map
                 // Also handle potential null or undefined values from the API response gracefully
                 const artifactLocation = artifact.Location;
                 const displayLocation = (artifactLocation !== null && artifactLocation !== undefined && locationMap[artifactLocation]) ? locationMap[artifactLocation] : artifactLocation || '未知';

                 // 处理 boolean 类型字段的显示
                 const isHotDisplay = artifact.IsHot ? '是' : '否';
                 const isNewDisplay = artifact.IsNew ? '是' : '否';

                 row.innerHTML = `
                     <td>${artifact.ID || 'N/A'}</td>
                     <td>${artifact.Name || 'N/A'}</td>
                     <td>${artifact.Category || '未知'}</td>
                     <td>${artifact.Era || '未知'}</td>
                     <td>${displayLocation}</td> <!-- Use the mapped location here -->
                     <td>${artifact.ViewCount || 0}</td> <!-- 显示浏览次数，默认为0 -->
                     <td>${isHotDisplay}</td>
                     <td>${isNewDisplay}</td>
                     <td>
                         <button class="btn btn-secondary btn-sm" onclick="editArtifact('${artifact.ID}')">编辑</button>
                         <button class="btn btn-secondary btn-sm" onclick="deleteArtifact('${artifact.ID}')">删除</button>
                     </td>
                 `;
                 artifactsTableBody.appendChild(row);
             });
        }


        // Function to handle adding or updating an artifact
        const artifactForm = document.getElementById('addArtifactForm');
        const submitButton = artifactForm ? artifactForm.querySelector('button[type="submit"]') : null; // 获取提交按钮

        if (artifactForm && submitButton) {
            artifactForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission

                // 禁用提交按钮防止重复提交
                submitButton.disabled = true;
                submitButton.textContent = window.editingArtifactId ? '更新中...' : '添加中...';

                // 获取文件输入框
                const imageFile = document.getElementById('artifactImageFile').files[0];
                const audioFile = document.getElementById('artifactAudioFile').files[0];

                let imageUrl = document.getElementById('artifactImageUrl').value;
                let audioUrl = document.getElementById('artifactAudioUrl').value;

                // 异步上传文件并获取URL
                async function uploadFile(file, fileType) {
                    if (!file) return null; // No file selected

                    console.log(`Uploading ${fileType} file:`, file.name);
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch('http://192.168.31.201:5000/api/upload', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (response.ok) {
                            console.log(`${fileType} upload successful:`, result.url);
                            return result.url;
                        } else {
                            throw new Error(result.error || `上传${fileType}文件失败`);
                        }
                    } catch (error) {
                        console.error(`Error uploading ${fileType} file:`, error);
                        throw error; // Re-throw the error to be caught by the main submit handler
                    }
                }

                try {
                    // 上传图片文件
                    if (imageFile) {
                        imageUrl = await uploadFile(imageFile, '图片');
                         // 清空文件输入框 (可选)
                         document.getElementById('artifactImageFile').value = '';
                    }

                    // 上传音频文件
                    if (audioFile) {
                        audioUrl = await uploadFile(audioFile, '音频');
                         // 清空文件输入框 (可选)
                         document.getElementById('artifactAudioFile').value = '';
                    }

                    // 收集表单数据 (使用上传后或原有的URL)
                    const artifactData = {
                        Name: document.getElementById('artifactName').value,
                        Category: document.getElementById('artifactCategory').value,
                        Era: document.getElementById('artifactEra').value,
                        Location: document.getElementById('artifactLocation').value,
                        Description: document.getElementById('artifactDescription').value,
                        ImageURL: imageUrl, // 使用上传后的URL或原有的URL
                        AudioURL: audioUrl,   // 使用上传后的URL或原有的URL
                        VideoURL: document.getElementById('artifactVideoUrl').value,
                        FeatureTags: document.getElementById('artifactFeatureTags').value,
                        IsHot: document.getElementById('artifactIsHot').checked,
                        IsNew: document.getElementById('artifactIsNew').checked
                    };

                    console.log('提交的文物数据:', artifactData);

                    let url;
                    let method;
                    let successMessage;
                    let errorMessage;

                    // 判断是添加还是编辑模式
                    if (window.editingArtifactId) {
                        // 编辑模式
                        url = `http://192.168.31.201:5000/api/artifacts/${window.editingArtifactId}`;
                        method = 'PUT';
                        successMessage = '文物更新成功！';
                        errorMessage = '更新文物失败';
                    } else {
                        // 添加模式
                        url = 'http://192.168.31.201:5000/api/artifacts';
                        method = 'POST';
                        successMessage = '文物添加成功！';
                        errorMessage = '添加文物失败';
                    }

                    // 向后端发送文物数据请求
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(artifactData),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message || successMessage);
                        artifactForm.reset();
                        resetArtifactForm(); // 重置表单到添加模式状态
                        loadArtifacts(); // 重新加载文物列表
                    } else {
                        const msg = result.message || errorMessage;
                        alert(`${errorMessage}: ${msg}`);
                        console.error(`${errorMessage}响应:`, result);
                    }

                } catch (error) {
                    // 捕获上传或提交文物数据过程中的错误
                    alert(`操作失败: ${error.message}`);
                    console.error('操作失败:', error);
                } finally {
                    // 恢复提交按钮状态
                    submitButton.disabled = false;
                    submitButton.textContent = window.editingArtifactId ? '更新文物' : '添加文物';
                }
            });
        }

        // Function to reset the artifact form to add mode
        function resetArtifactForm() {
            window.editingArtifactId = null;
            const submitButton = document.querySelector('#addArtifactForm button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = '添加文物';
            }
            // 清空表单（由 form.reset() 处理）
        }

        // Function to handle artifact search (filters currently loaded artifacts)
        function searchArtifacts() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toUpperCase(); // Get input value and convert to uppercase for case-insensitive search
            const allArtifacts = window.currentArtifacts || []; // Get artifacts from stored data

            const filteredArtifacts = allArtifacts.filter(artifact => {
                // Search in ID, Name, Era, Location, Description (adjust fields as needed based on backend response)
                // Ensure artifact properties match those returned by the backend /api/artifacts GET endpoint
                const idMatch = artifact.ID && String(artifact.ID).toUpperCase().includes(filter); // Convert ID to string for search
                const nameMatch = artifact.Name && String(artifact.Name).toUpperCase().includes(filter);
                const eraMatch = artifact.Era && String(artifact.Era).toUpperCase().includes(filter);
                // Use the raw Location value from the backend for searching before mapping for display
                const locationMatch = artifact.Location && String(artifact.Location).toUpperCase().includes(filter);
                const descriptionMatch = artifact.Description && String(artifact.Description).toUpperCase().includes(filter);


                return idMatch || nameMatch || eraMatch || locationMatch || descriptionMatch;
            });

            displayArtifacts(filteredArtifacts); // Display filtered results
        }


        // Function to handle Edit artifact button click
        function editArtifact(id) {
            // 在已加载的文物列表中查找要编辑的文物
            // 将传入的字符串ID转换为数字进行查找
            const artifactIdNum = parseInt(id, 10); // 将字符串ID转换为整数
            const artifactToEdit = window.currentArtifacts.find(artifact => artifact.ID === artifactIdNum);

            if (artifactToEdit) {
                // 将文物数据填充到表单
                document.getElementById('artifactName').value = artifactToEdit.Name || '';
                document.getElementById('artifactCategory').value = artifactToEdit.Category || '';
                document.getElementById('artifactEra').value = artifactToEdit.Era || '';
                document.getElementById('artifactLocation').value = artifactToEdit.Location || '';
                document.getElementById('artifactDescription').value = artifactToEdit.Description || '';
                document.getElementById('artifactImageUrl').value = artifactToEdit.ImageURL || '';
                document.getElementById('artifactAudioUrl').value = artifactToEdit.AudioURL || '';
                document.getElementById('artifactVideoUrl').value = artifactToEdit.VideoURL || '';
                document.getElementById('artifactFeatureTags').value = artifactToEdit.FeatureTags || '';
                document.getElementById('artifactIsHot').checked = artifactToEdit.IsHot || false;
                document.getElementById('artifactIsNew').checked = artifactToEdit.IsNew || false;

                // 设置正在编辑的文物ID，并改变按钮文本
                window.editingArtifactId = id;
                const submitButton = document.querySelector('#addArtifactForm button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = '更新文物';
                }

                // 可以滚动到表单区域，方便用户编辑
                artifactForm.scrollIntoView({ behavior: 'smooth' });

            } else {
                alert('未找到要编辑的文物。');
                console.error('未找到要编辑的文物，ID:', id);
            }
        }

        // Function to handle delete artifact button click
        function deleteArtifact(id) {
             if (confirm('确定要删除文物编号为 ' + id + ' 的文物吗？')) {
                 deleteArtifactFromBackend(id); // Call the new function to delete from backend
             }
        }

        // Function to delete artifact from backend
        async function deleteArtifactFromBackend(id) {
            try {
                // 向后端发送DELETE请求
                const response = await fetch(`http://192.168.31.201:5000/api/artifacts/${id}`, {
                    method: 'DELETE',
                });

                const result = await response.json();

                if (response.ok) {
                    // 请求成功，显示成功消息并刷新文物列表
                    alert(result.message || '文物删除成功！');
                    loadArtifacts(); // 重新加载文物列表
                } else {
                    // 请求失败，显示错误消息
                    const errorMessage = result.message || '删除文物失败';
                    alert(`删除文物失败: ${errorMessage}`);
                    console.error('删除文物失败响应:', result);
                }

            } catch (error) {
                // 网络或其他错误
                console.error('发送删除文物请求时出错:', error);
                alert(`删除文物失败: ${error.message}`);
            }
        }


        // Placeholder function for QR scan simulation
        function simulateQRScan() {
            alert('模拟二维码扫描功能待实现');
            // TODO: Implement actual QR scanning using a library or API
        }

        // Function to load device data from the backend API
        async function loadDeviceData() {
             console.log("Loading device data...");

             const devicesTableBody = document.getElementById('devicesTableBody');
              if (!devicesTableBody) {
                   console.error('Devices table body not found.');
                   return;
               }
               devicesTableBody.innerHTML = '<tr><td colspan="10">加载中...</td></tr>'; // Loading indicator

               try {
                   const response = await fetch('http://192.168.31.201:5000/api/devices');
                   if (!response.ok) {
                       throw new Error(`HTTP error! status: ${response.status}`);
                   }
                   const devices = await response.json();

                   window.currentDevices = devices; // Store device data

                   displayDeviceStatus(devices); // 显示设备状态列表

                   // 更新环境监控和人流监控统计卡片
                   updateEnvironmentAndVisitorStats(devices); // 新增：调用函数更新统计数据

               } catch (error) {
                   console.error('Error loading devices:', error);
                   devicesTableBody.innerHTML = `<tr><td colspan="10" style="color: red;">加载设备数据失败: ${error.message}</td></tr>`;
               }
         }

         // Function to update environment and visitor stats (New Function)
         function updateEnvironmentAndVisitorStats(devices) {
             console.log("Updating environment and visitor stats...");

             let temperature = '--';
             let humidity = '--';
             let currentVisitors = '--';
             let peakTime = '--:--'; // 通常需要历史数据计算，这里暂时静态或模拟

             if (devices && devices.length > 0) {
                 // 遍历设备数据，查找环境和人流设备
                 devices.forEach(device => {
                     if (device.DeviceType === 'temperature' && device.Value !== null) {
                         temperature = parseFloat(device.Value).toFixed(1); // 假设Value是温度值
                     } else if (device.DeviceType === 'humidity' && device.Value !== null) {
                         humidity = parseFloat(device.Value).toFixed(0); // 假设Value是湿度值
                     } else if ((device.DeviceType === 'visitor_counter' || device.DeviceType === 'camera') && device.Value !== null) {
                          // 假设提供了当前人流计数，优先 visitor_counter
                          if (device.DeviceType === 'visitor_counter') {
                               currentVisitors = parseInt(device.Value, 10);
                          } else if (device.DeviceType === 'camera' && currentVisitors === '--') {
                              // 如果没有visitor_counter，尝试使用camera的值（如果提供了人数）
                               // 这里假设camera的Value也可能是人数，如果不是请根据实际情况调整
                              currentVisitors = parseInt(device.Value, 10);
                          }
                     }
                     // 可以在这里添加其他类型的设备处理，如空气质量等
                 });
             }

             // 如果没有从后端获取到数据，使用模拟数据填充
             if (temperature === '--') temperature = (22.5 + Math.random() * 3).toFixed(1); // 模拟温度
             if (humidity === '--') humidity = (55 + Math.random() * 10).toFixed(0); // 模拟湿度
             if (currentVisitors === '--') currentVisitors = Math.floor(30 + Math.random() * 50); // 模拟人流
             // Peak Time remains static for now
             // peakTime = '14:30'; // 模拟高峰时段

             // 更新页面上的统计元素
             const temperatureElement = document.getElementById('temperature');
             const humidityElement = document.getElementById('humidity');
             const currentVisitorsElement = document.getElementById('currentVisitors');
             const peakTimeElement = document.getElementById('peakTime');

             if (temperatureElement) temperatureElement.textContent = temperature + '°C';
             if (humidityElement) humidityElement.textContent = humidity + '%';
             if (currentVisitorsElement) currentVisitorsElement.textContent = currentVisitors;
             if (peakTimeElement) peakTimeElement.textContent = peakTime; // 设置静态或模拟的高峰时段

              // TODO: 如果有设备告警，可以在这里根据 AlertLevel 和 AlertMessage 更新告警区域
         }

         function controlDevice(name) {
             alert(`设备控制：${name}\n（在实际应用中会显示设备控制面板）`);
             // Implement device control logic
         }

         // Function to load activities from the backend API (New Function)
         async function loadActivityData() {
             const activitiesTableBody = document.getElementById('activitiesTableBody');
             if (!activitiesTableBody) {
                 console.error('Activities table body not found.');
                 return;
             }
             activitiesTableBody.innerHTML = '<tr><td colspan="10">加载中...</td></tr>'; // Loading indicator, update colspan if needed

             try {
                 const response = await fetch('http://192.168.31.201:5000/api/activities');
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 const activities = await response.json();

                 window.currentActivities = activities; // 存储活动数据

                 displayActivities(activities); // 显示活动列表

                 // TODO: Update activity related stats in overview or activity section if any

             } catch (error) {
                 console.error('Error loading activities:', error);
                 activitiesTableBody.innerHTML = `<tr><td colspan="10" style="color: red;">加载活动数据失败: ${error.message}</td></tr>`; // Update colspan if needed
             }
         }

         // Function to display activities in the table (New Function)
         function displayActivities(activitiesToDisplay) {
             const activitiesTableBody = document.getElementById('activitiesTableBody');
             if (!activitiesTableBody) {
                 console.error('Activities table body not found for display.');
                 return;
             }
             activitiesTableBody.innerHTML = ''; // Clear previous entries

             if (activitiesToDisplay.length === 0) {
                 activitiesTableBody.innerHTML = '<tr><td colspan="10">暂无活动数据。</td></tr>'; // Update colspan if needed
                 return;
             }

             activitiesToDisplay.forEach(activity => {
                 const row = document.createElement('tr');

                 // 处理 boolean 类型字段的显示
                 const isPublishedDisplay = activity.IsPublished ? '是' : '否';

                 // 处理日期时间格式，只显示日期和时间，移除秒和时区信息
                 const formatDateTime = (datetimeString) => {
                      if (!datetimeString) return '';
                      try {
                          // ISO格式字符串示例: 2023-10-27T10:30:00 or 2023-10-27T10:30:00.000Z
                          // datetime-local 输出格式示例: 2023-10-27T10:30
                          // 目标格式示例: 2023-10-27 10:30
                          const date = new Date(datetimeString);
                          // 使用 Intl.DateTimeFormat 或手动构建格式
                          const year = date.getFullYear();
                          const month = ('0' + (date.getMonth() + 1)).slice(-2);
                          const day = ('0' + date.getDate()).slice(-2);
                          const hours = ('0' + date.getHours()).slice(-2);
                          const minutes = ('0' + date.getMinutes()).slice(-2);
                          return `${year}-${month}-${day} ${hours}:${minutes}`;
                      } catch (e) {
                          console.error('Error formatting date:', datetimeString, e);
                          return datetimeString; // 格式化失败时返回原始字符串
                      }
                  };

                 const startTimeDisplay = formatDateTime(activity.StartTime);
                 const endTimeDisplay = formatDateTime(activity.EndTime);


                 row.innerHTML = `
                     <td>${activity.ID || 'N/A'}</td>
                     <td>${activity.Title || 'N/A'}</td>
                     <td>${activity.Type || '未知'}</td>
                     <td>${startTimeDisplay}</td>
                     <td>${endTimeDisplay}</td>
                     <td>${activity.Location || '未知'}</td>
                      <td>${activity.MaxParticipants || '不限'}</td>
                     <td>${activity.CurrentParticipants || 0}</td>
                     <td>${isPublishedDisplay}</td>
                     <td>
                         <button class="btn btn-secondary btn-sm" onclick="editActivityItem('${activity.ID}')">编辑</button>
                         <button class="btn btn-secondary btn-sm" onclick="deleteActivityItem('${activity.ID}')">删除</button>
                     </td>
                 `;
                 activitiesTableBody.appendChild(row);
             });
         }
         // 异步上传文件并获取URL (全局可用的函数)
         // 将此函数放在所有需要调用它的表单提交逻辑的上方
         async function uploadFile(file, fileType) {
             if (!file) return null; // No file selected

             console.log(`Uploading ${fileType} file:`, file.name);
             const formData = new FormData();
             formData.append('file', file);

             try {
                 const response = await fetch('http://192.168.31.201:5000/api/upload', {
                     method: 'POST',
                     body: formData
                 });

                 const result = await response.json();

                 if (response.ok) {
                     console.log(`${fileType} upload successful:`, result.url);
                     return result.url;
                 } else {
                     throw new Error(result.error || `上传${fileType}文件失败`);
                 }
             } catch (error) {
                 console.error(`Error uploading ${fileType} file:`, error);
                 throw error; // Re-throw the error to be caught by the main submit handler
             }
         }

         // Function to handle adding or updating an activity (New Function)
         const activityForm = document.getElementById('addActivityForm');
         const activitySubmitButton = activityForm ? activityForm.querySelector('button[type="submit"]') : null; // 获取提交按钮

         if (activityForm && activitySubmitButton) {
             activityForm.addEventListener('submit', async function(event) {
                 event.preventDefault(); // Prevent default form submission

                 // 禁用提交按钮防止重复提交
                 activitySubmitButton.disabled = true;
                 activitySubmitButton.textContent = window.editingActivityId ? '更新中...' : '添加中...';

                 // 获取文件输入框
                 const activityImageFile = document.getElementById('activityImageFile').files[0];

                 let activityImageUrl = document.getElementById('activityImageUrl').value;

                 try {
                     // 上传图片文件
                     if (activityImageFile) {
                         activityImageUrl = await uploadFile(activityImageFile, '活动图片');
                          // 清空文件输入框 (可选)
                          document.getElementById('activityImageFile').value = '';
                     }

                     // 收集表单数据 (使用上传后或原有的URL)
                     const activityData = {
                         Title: document.getElementById('activityTitle').value,
                         Type: document.getElementById('activityType').value,
                         StartTime: document.getElementById('activityStartTime').value,
                         EndTime: document.getElementById('activityEndTime').value,
                         Location: document.getElementById('activityLocation').value,
                         Description: document.getElementById('activityDescription').value,
                         ImageURL: activityImageUrl, // 使用上传后的URL或原有的URL
                         MaxParticipants: parseInt(document.getElementById('activityMaxParticipants').value, 10) || null,
                         IsPublished: document.getElementById('activityIsPublished').checked
                     };

                  console.log('提交的活动数据:', activityData);

                 let url;
                 let method;
                 let successMessage;
                 let errorMessage;

                 // 判断是添加还是编辑模式
                 if (window.editingActivityId) {
                     // 编辑模式
                     url = `http://192.168.31.201:5000/api/activities/${window.editingActivityId}`;
                     method = 'PUT';
                     successMessage = '活动更新成功！';
                     errorMessage = '更新活动失败';
                 } else {
                     // 添加模式
                     url = 'http://192.168.31.201:5000/api/activities';
                     method = 'POST';
                     successMessage = '活动添加成功！';
                     errorMessage = '添加活动失败';
                 }

                 // 向后端发送请求
                 const response = await fetch(url, {
                     method: method,
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify(activityData),
                 });

                 const result = await response.json();

                 if (response.ok) {
                     alert(result.message || successMessage);
                     activityForm.reset();
                     resetActivityForm(); // 重置表单到添加模式状态
                     loadActivityData(); // 重新加载活动列表
                 } else {
                     const msg = result.message || errorMessage;
                     alert(`${errorMessage}: ${msg}`);
                     console.error(`${errorMessage}响应:`, result);
                 }

             } catch (error) {
                  // 捕获上传或提交活动数据过程中的错误
                 alert(`操作失败: ${error.message}`);
                 console.error('操作失败:', error);
             } finally {
                 // 恢复提交按钮状态
                 activitySubmitButton.disabled = false;
                 activitySubmitButton.textContent = window.editingActivityId ? '更新活动' : '添加活动';
             }
         });
     }
        
        // Function to reset the activity form to add mode (New Function)
        function resetActivityForm() {
            window.editingActivityId = null;
            const activitySubmitButton = document.querySelector('#addActivityForm button[type="submit"]');
            if (activitySubmitButton) {
                activitySubmitButton.textContent = '添加活动';
            }
            // 清空表单（由 form.reset() 处理）
            // 如果需要清空一些非文本字段（如checkbox），可以在这里手动设置
        }

        // Function to handle Edit activity button click (New Function)
        function editActivityItem(id) {
            // 在已加载的活动列表中查找要编辑的活动
            const activityIdNum = parseInt(id, 10); // 将字符串ID转换为整数
            const activityToEdit = window.currentActivities.find(activity => activity.ID === activityIdNum);

            if (activityToEdit) {
                // 将活动数据填充到表单
                document.getElementById('activityTitle').value = activityToEdit.Title || '';
                document.getElementById('activityType').value = activityToEdit.Type || '';
                // 注意：datetime-local 输入框需要 YYYY-MM-DDTHH:MM 格式的字符串
                document.getElementById('activityStartTime').value = activityToEdit.StartTime ? new Date(activityToEdit.StartTime).toISOString().slice(0, 16) : '';
                document.getElementById('activityEndTime').value = activityToEdit.EndTime ? new Date(activityToEdit.EndTime).toISOString().slice(0, 16) : '';

                document.getElementById('activityLocation').value = activityToEdit.Location || '';
                document.getElementById('activityDescription').value = activityToEdit.Description || '';
                document.getElementById('activityImageUrl').value = activityToEdit.ImageURL || '';
                document.getElementById('activityMaxParticipants').value = activityToEdit.MaxParticipants || ''; // Number input can take empty string
                document.getElementById('activityIsPublished').checked = activityToEdit.IsPublished || false;

                // 设置正在编辑的活动ID，并改变按钮文本
                window.editingActivityId = id;
                const activitySubmitButton = document.querySelector('#addActivityForm button[type="submit"]');
                if (activitySubmitButton) {
                    activitySubmitButton.textContent = '更新活动';
                }

                // 可以滚动到表单区域，方便用户编辑
                activityForm.scrollIntoView({ behavior: 'smooth' });

            } else {
                alert('未找到要编辑的活动。');
                console.error('未找到要编辑的活动，ID:', id);
            }
        }

        // Function to handle delete activity button click (New Function)
        function deleteActivityItem(id) {
              if (confirm('确定要删除活动ID为 ' + id + ' 的活动吗？')) {
                  deleteActivityFromBackend(id); // Call the new function to delete from backend
              }
         }

         // Function to delete activity from backend (New Function)
         async function deleteActivityFromBackend(id) {
             try {
                 // 将传入的字符串ID转换为整数，虽然DELETE请求URL是字符串，但为了逻辑一致性
                  const activityIdNum = parseInt(id, 10);
                 // 向后端发送DELETE请求
                 const response = await fetch(`http://192.168.31.201:5000/api/activities/${activityIdNum}`, {
                     method: 'DELETE',
                 });

                 const result = await response.json();

                 if (response.ok) {
                     // 请求成功，显示成功消息并刷新活动列表
                     alert(result.message || '活动删除成功！');
                     loadActivityData(); // 重新加载活动列表
                 } else {
                     // 请求失败，显示错误消息
                     const errorMessage = result.message || '删除活动失败';
                     alert(`删除活动失败: ${errorMessage}`);
                     console.error('删除活动失败响应:', result);
                 }

             } catch (error) {
                 // 网络或其他错误
                 console.error('发送删除活动请求时出错:', error);
                 alert(`删除活动失败: ${error.message}`);
             }
         }

         function loadVisitorData() {
             console.log("Loading visitor data (placeholder)");
             // TODO: Implement fetching and displaying visitor data
         }

         // Function to display devices in the table (New Function)
         function displayDeviceStatus(devicesToDisplay) {
             const devicesTableBody = document.getElementById('devicesTableBody');
             if (!devicesTableBody) {
                 console.error('Devices table body not found.');
                 return;
             }
             devicesTableBody.innerHTML = ''; // Clear previous entries

             if (devicesToDisplay.length === 0) {
                 devicesTableBody.innerHTML = '<tr><td colspan="10">暂无设备数据。</td></tr>';
                 return;
             }

             devicesToDisplay.forEach(device => {
                 const row = document.createElement('tr');

                  // 处理状态颜色
                  let statusClass = '';
                  if (device.Status === '在线') {
                      statusClass = 'status-online';
                  } else if (device.Status === '离线') {
                      statusClass = 'status-offline';
                  } else if (device.Status === '告警' || device.AlertLevel === 'High' || device.AlertLevel === 'Medium') {
                      statusClass = 'status-warning';
                  }

                  // 处理更新时间格式
                  const formatUpdateTime = (datetimeString) => {
                      if (!datetimeString) return '';
                       try {
                          const date = new Date(datetimeString);
                          // 可以显示多久前更新，或者具体的日期时间
                          // 例如：使用 toLocaleString() 或者自定义格式
                          return date.toLocaleString(); // 显示本地化的日期和时间
                       } catch (e) {
                           console.error('Error formatting update time:', datetimeString, e);
                           return datetimeString; // 格式化失败时返回原始字符串
                       }
                  };

                  const updateTimeDisplay = formatUpdateTime(device.UpdateTime);


                 row.innerHTML = `
                     <td>${device.ID || 'N/A'}</td>
                     <td>${device.DeviceID || 'N/A'}</td>
                     <td>${device.DeviceType || '未知'}</td>
                     <td>${device.Location || '未知'}</td>
                     <td><span class="device-status ${statusClass}">${device.Status || '未知'}</span></td>
                     <td>${device.Value || 'N/A'}</td>
                     <td>${device.Battery !== null ? device.Battery : 'N/A'}</td>
                     <td>${device.AlertLevel || '无告警'}</td>
                     <td>${device.AlertMessage || '无'}</td>
                     <td>${updateTimeDisplay}</td>
                 `;
                 // 注意：设备管理页面目前没有编辑和删除操作，所以不添加操作按钮
                 // 如果需要控制设备，可以添加控制按钮并实现相应函数

                 devicesTableBody.appendChild(row);
             });
         }

        // Initial setup when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
             // Attach event listeners to navigation buttons to call showSection
             document.querySelectorAll('.main-nav .nav-btn').forEach(button => {
                 button.addEventListener('click', () => {
                     // Extract sectionId from the onclick attribute safely
                     const onclickAttr = button.getAttribute('data-target');
                     if (onclickAttr) {
                         showSection(onclickAttr);
                     } else {
                         console.error('Could not extract sectionId from data-target attribute:', onclickAttr);
                         // Fallback to overview if extraction fails for a button
                         showSection('overview');
                     }
                 });
             });

             // Add event listener for the search input in the artifacts section
             const searchInput = document.getElementById('searchInput');
             if (searchInput) {
                 searchInput.addEventListener('input', searchArtifacts);
             }

             // Add event listener to the form's reset event to also reset editing state
             if (artifactForm) {
                  artifactForm.addEventListener('reset', resetArtifactForm);
             }

             // Add event listener to the activity form's reset event to also reset editing state
             if (activityForm) {
                  activityForm.addEventListener('reset', resetActivityForm);
             }

             // Initial data loading for the default active section (already handled by initial showSection call)
             // Any section that is active on load will have its data loading function called by showSection
        });

        // --- 新增：模拟用户角色控制和导航显示 --- START

        // Function to set mock user role and update UI
        function setMockUserRole(role) {
            window.currentUserRole = role;
            document.getElementById('currentRoleDisplay').textContent = `当前角色: ${role === 'Normal' ? '普通用户' : '管理员'}`;
            console.log('模拟用户角色设置为:', role);
            updateNavigationVisibility(); // Call function to update navigation
            // Optionally, redirect to overview or home page after changing role
            showSection('overview');
        }

        // Function to update navigation menu visibility based on role
        function updateNavigationVisibility() {
            const navBtns = document.querySelectorAll('.main-nav .nav-btn');
            const normalUserSections = ['overview', 'artifact-info', 'multimedia-interaction', 'community', 'ai-qa']; // 普通用户可见的 section
            const adminSections = ['overview', 'artifact-management', 'device-management', 'activity-management', 'exhibition-hall-management', 'user-management', 'data-dashboard']; // 管理员可见的 section

            navBtns.forEach(btn => {
                const sectionId = btn.getAttribute('data-target');
                let isVisible = false;

                if (window.currentUserRole === 'Normal') {
                    if (normalUserSections.includes(sectionId)) {
                        isVisible = true;
                    }
                } else if (window.currentUserRole === 'Admin') {
                     if (adminSections.includes(sectionId)) {
                         isVisible = true;
                     }
                } else {
                     isVisible = true; // 默认所有可见
                }

                btn.style.display = isVisible ? '' : 'none';
            });
             const activeBtn = document.querySelector('.main-nav .nav-btn.active');
             if (activeBtn && activeBtn.style.display === 'none'){
                  showSection('overview');
             }
        }

        // Add event listener for DOMContentLoaded to initialize navigation visibility
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing DOMContentLoaded logic ...
            updateNavigationVisibility(); // Call here after initial showSection
        });

        // --- 新增：模拟用户角色控制和导航显示 --- END


        // --- 展厅管理相关的JavaScript函数 (新增) ---

        // Function to load exhibition hall data from the backend API
        async function loadExhibitionHallData() {
            const exhibitionHallsTableBody = document.getElementById('exhibitionHallsTableBody');
            if (!exhibitionHallsTableBody) {
                console.error('Exhibition halls table body not found.');
                return;
            }
            exhibitionHallsTableBody.innerHTML = '<tr><td colspan="6">加载中...</td></tr>'; // Loading indicator

            try {
                const response = await fetch('http://192.168.31.201:5000/api/exhibition_halls');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const exhibitionHalls = await response.json();

                window.currentExhibitionHalls = exhibitionHalls; // Store exhibition halls data

                displayExhibitionHalls(exhibitionHalls); // Display exhibition halls

                // TODO: Update related stats in overview or exhibition hall management section if any

            } catch (error) {
                console.error('Error loading exhibition halls:', error);
                exhibitionHallsTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">加载展厅数据失败: ${error.message}</td></tr>`;
            }
        }

        // Function to display exhibition halls in the table
        function displayExhibitionHalls(exhibitionHallsToDisplay) {
            const exhibitionHallsTableBody = document.getElementById('exhibitionHallsTableBody');
            if (!exhibitionHallsTableBody) {
                console.error('Exhibition halls table body not found for display.');
                return;
            }
            exhibitionHallsTableBody.innerHTML = ''; // Clear previous entries

            if (exhibitionHallsToDisplay.length === 0) {
                exhibitionHallsTableBody.innerHTML = '<tr><td colspan="6">暂无展厅数据。</td></tr>'; // Update colspan
                return;
            }

            exhibitionHallsToDisplay.forEach(exhibitionHall => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${exhibitionHall.ID || 'N/A'}</td>
                    <td>${exhibitionHall.Name || 'N/A'}</td>
                    <td>${exhibitionHall.Floor || '未知'}</td>
                    <td>${exhibitionHall.AreaCode || '未知'}</td>
                    <td>${exhibitionHall.ArtifactCount || 0}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editExhibitionHall('${exhibitionHall.ID}')">编辑</button>
                        <button class="btn btn-secondary btn-sm" onclick="deleteExhibitionHall('${exhibitionHall.ID}')">删除</button>
                    </td>
                `;
                exhibitionHallsTableBody.appendChild(row);
            });
        }

        // --- 展厅管理相关的JavaScript函数结束 ---

        // --- 用户行为相关的JavaScript函数 (新增) ---

        // Function to load user behavior data from the backend API
        async function loadUserBehaviorData() {
            console.log("Loading user behavior data...");

            const userBehaviorsTableBody = document.getElementById('userBehaviorsTableBody');
             if (!userBehaviorsTableBody) {
                  console.error('User behaviors table body not found.');
                  return;
              }
             userBehaviorsTableBody.innerHTML = '<tr><td colspan="8">加载中...</td></tr>'; // Loading indicator

              try {
                  const response = await fetch('http://192.168.31.201:5000/api/user_behaviors'); // 假设新的接口 /api/user_behaviors
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const behaviors = await response.json();

                  window.currentUserBehaviors = behaviors; // Store user behaviors globally

                  // Call display functions for relevant sections if they are active
                  const activeSectionId = document.querySelector('.section.active').id;
                   if (activeSectionId === 'data-dashboard') {
                       displayUserBehaviorData(); // Display in dashboard table
                   } else if (activeSectionId === 'community') {
                       displayCommunityPosts(); // Display in community list
                   }

              } catch (error) {
                  console.error('Error loading user behaviors:', error);
                  userBehaviorsTableBody.innerHTML = `<tr><td colspan="8" style="color: red;">加载用户行为数据失败: ${error.message}</td></tr>`;
              }
        }

        // Function to display user behavior items in the table (New Function)
        function displayUserBehaviorData() { // Removed parameter, will use global data
             const userBehaviorsTableBody = document.getElementById('userBehaviorsTableBody');
              if (!userBehaviorsTableBody) {
                   console.error('User behaviors table body not found for display.');
                   return;
               }
             userBehaviorsTableBody.innerHTML = ''; // Clear previous entries

             const allBehaviors = window.currentUserBehaviors || []; // Use global data

             if (allBehaviors.length === 0) {
                 userBehaviorsTableBody.innerHTML = '<tr><td colspan="8">暂无用户行为数据。</td></tr>'; // Update colspan
                 return;
             }

              const artifactMap = {};
              // 构建文物ID到名称的映射，以便在行为列表中显示文物名称 (如果文物数据已加载)
              if (window.currentArtifacts) {
                  window.currentArtifacts.forEach(artifact => {
                      artifactMap[artifact.ID] = artifact.Name;
                  });
              }

             allBehaviors.forEach(item => { // Iterate over global data
                 const row = document.createElement('tr');

                  // 处理 datetime 格式
                   const formatDateTime = (datetimeString) => {
                        if (!datetimeString) return '';
                        try {
                            const date = new Date(datetimeString);
                            return date.toLocaleString();
                         } catch (e) {
                             return datetimeString;
                         }
                    };
                  const createTimeDisplay = formatDateTime(item.CreateTime);

                  // 根据 ArtifactID 查找文物名称
                  const artifactName = item.ArtifactID !== null && artifactMap[item.ArtifactID] ? artifactMap[item.ArtifactID] : '无关联文物';

                 row.innerHTML = `
                     <td>${item.ID || 'N/A'}</td>
                     <td>${item.UserID || '匿名'}</td>
                     <td>${artifactName}</td>
                     <td>${item.BehaviorType || '未知'}</td>
                     <td>${item.Duration !== null ? item.Duration : 'N/A'}</td>
                     <td>${item.Content || ''}</td>
                     <td>${item.Location || '未知'}</td>
                     <td>${createTimeDisplay}</td>
                 `;
                 // 用户行为通常只有查看，没有编辑删除操作，所以不添加操作按钮

                 userBehaviorsTableBody.appendChild(row);
             });
         }

        // --- 用户行为相关的JavaScript函数结束 ---

        // --- 用户管理相关的JavaScript函数 (新增) ---

        // Function to load user data from the backend API
        async function loadUserData() {
            console.log("Loading user data...");

            const usersTableBody = document.getElementById('usersTableBody');
             if (!usersTableBody) {
                  console.error('Users table body not found.');
                  return;
              }
             usersTableBody.innerHTML = '<tr><td colspan="10">加载中...</td></tr>'; // Update colspan

              try {
                  const response = await fetch('http://192.168.31.201:5000/api/users'); // 假设新的接口 /api/users
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const users = await response.json();

                  window.currentUsers = users; // 存储用户数据

                  displayUsers(users); // 显示用户列表

                  // TODO: Update related stats in overview or user management section if any

              } catch (error) {
                  console.error('Error loading users:', error);
                  usersTableBody.innerHTML = `<tr><td colspan="10" style="color: red;">加载用户数据失败: ${error.message}</td></tr>`; // Update colspan
              }
        }

        // Function to display user items in the table (New Function)
        function displayUsers(usersToDisplay) {
            const usersTableBody = document.getElementById('usersTableBody');
             if (!usersTableBody) {
                  console.error('Users table body not found for display.');
                  return;
              }
            usersTableBody.innerHTML = ''; // Clear previous entries

            if (usersToDisplay.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="10">暂无用户数据。</td></tr>'; // Update colspan
                return;
            }

            usersToDisplay.forEach(item => {
                const row = document.createElement('tr');

                 // 处理 datetime 格式
                  const formatDateTime = (datetimeString) => {
                       if (!datetimeString) return '';
                       try {
                           const date = new Date(datetimeString);
                           return date.toLocaleString();
                        } catch (e) {
                            return datetimeString;
                        }
                   };
                 const createTimeDisplay = formatDateTime(item.CreateTime);
                 const lastLoginTimeDisplay = formatDateTime(item.LastLoginTime);

                row.innerHTML = `
                    <td>${item.ID || 'N/A'}</td>
                    <td>${item.OpenID || 'N/A'}</td>
                    <td>${item.Nickname || '匿名用户'}</td>
                    <td><img src="${item.AvatarURL || ''}" alt="Avatar" width="30" height="30"></td>
                    <td>${item.Gender || '未知'}</td>
                    <td>${item.AgeGroup || '未知'}</td>
                    <td>${item.VisitCount || 0}</td>
                    <td>${item.FavoriteCount || 0}</td>
                    <td>${item.Role || '普通用户'}</td>
                    <td>${createTimeDisplay}</td>
                    <td>${lastLoginTimeDisplay}</td>
                    <td>
                         <button class="btn btn-secondary btn-sm" onclick="editUser('${item.ID}')">编辑</button>
                         <button class="btn btn-secondary btn-sm" onclick="deleteUser('${item.ID}')">删除</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
        }

        // --- 用户管理相关的JavaScript函数结束 ---

        // Function to handle delete user button click
        async function deleteUser(id) {
             if (confirm('确定要删除用户ID为 ' + id + ' 的用户吗？')) {
                 try {
                     // 向后端发送DELETE请求
                     const response = await fetch(`http://192.168.31.201:5000/api/users/${id}`, {
                         method: 'DELETE',
                     });

                     const result = await response.json();

                     if (response.ok) {
                         // 请求成功，显示成功消息并刷新用户列表
                         alert(result.message || '用户删除成功！');
                         loadUserData(); // 重新加载用户列表
                     } else {
                         // 请求失败，显示错误消息
                         const errorMessage = result.message || '删除用户失败';
                         alert(`删除用户失败: ${errorMessage}`);
                         console.error('删除用户失败响应:', result);
                     }

                 } catch (error) {
                     // 网络或其他错误
                     console.error('发送删除用户请求时出错:', error);
                     alert(`删除用户失败: ${error.message}`);
                 }
             }
        }

        // Note: editUser function is placeholder as per user request to skip edit functionality
        function editUser(id) {
             console.log("Edit User function (placeholder) for ID:", id);
             alert('编辑用户功能待实现'); // Placeholder alert
             // TODO: Implement edit logic if needed later
        }

        // --- 用户管理相关的JavaScript函数 (新增) ---

        // Function to handle adding or updating a user
        const userForm = document.getElementById('addUserForm'); // Assume the form will have this ID
        const userSubmitButton = userForm ? userForm.querySelector('button[type="submit"]') : null; // Assume the form has a submit button

        if (userForm && userSubmitButton) {
            userForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission

                // 收集表单数据
                const userData = {
                    OpenID: document.getElementById('userOpenID').value || null,
                    Nickname: document.getElementById('userNickname').value || null,
                    AvatarURL: document.getElementById('userAvatarURL').value || null,
                    Gender: document.getElementById('userGender').value || null,
                    AgeGroup: document.getElementById('userAgeGroup').value || null,
                    Role: document.getElementById('userRole').value || null,
                    // VisitCount, FavoriteCount, CreateTime, LastLoginTime, ID 通常由后端处理或不需要前端提交
                };

                console.log('提交的用户数据:', userData);

                let url;
                let method;
                let successMessage;
                let errorMessage;

                // 判断是添加还是编辑模式
                if (window.editingUserId) {
                    // 编辑模式 (暂时不需要，但保留结构)
                    url = `http://192.168.31.201:5000/api/users/${window.editingUserId}`;
                    method = 'PUT';
                    successMessage = '用户更新成功！';
                    errorMessage = '更新用户失败';
                } else {
                    // 添加模式
                    url = 'http://192.168.31.201:5000/api/users';
                    method = 'POST';
                    successMessage = '用户添加成功！';
                    errorMessage = '添加用户失败';
                }

                try {
                    // 向后端发送请求
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userData),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // 请求成功，显示成功消息，清空表单，并刷新用户列表
                        alert(result.message || successMessage);
                        userForm.reset();
                        resetUserForm(); // 重置表单到添加模式状态
                        loadUserData(); // 重新加载用户列表
                    } else {
                        // 请求失败，显示错误消息
                        const msg = result.message || errorMessage;
                        alert(`${errorMessage}: ${msg}`);
                        console.error(`${errorMessage}响应:`, result);
                    }

                } catch (error) {
                    // 网络或其他错误
                    console.error(`发送${method}用户请求时出错:`, error);
                    alert(`${errorMessage}: ${error.message}`);
                }
            });
        }

        // Function to reset the user form to add mode
        function resetUserForm() {
            window.editingUserId = null;
            const submitButton = document.querySelector('#addUserForm button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = '添加用户';
            }
            // 清空表单（由 form.reset() 处理）
        }

        // Function to display artifacts in the audience view (New Function)
        function displayArtifactsForAudience(artifactsToDisplay) {
            const audienceArtifactListDiv = document.getElementById('audienceArtifactList');
            if (!audienceArtifactListDiv) {
                console.error('Audience artifact list div not found.');
                return;
            }
            audienceArtifactListDiv.innerHTML = ''; // Clear previous entries

            if (artifactsToDisplay.length === 0) {
                audienceArtifactListDiv.innerHTML = '<p>暂无文物数据。</p>';
                return;
            }

            // Create a grid container for cards (optional, based on desired layout)
            const cardGrid = document.createElement('div');
            cardGrid.classList.add('card-grid'); // Reuse existing card-grid style

            artifactsToDisplay.forEach(artifact => {
                const artifactCard = document.createElement('div');
                artifactCard.classList.add('card'); // Reuse existing card style
                artifactCard.style.marginBottom = '20px'; // Add some spacing

                // Basic card content - you can expand this with more details
                artifactCard.innerHTML = `
                    <h3>${artifact.Name || '未知文物'}</h3>
                    ${artifact.ImageURL ? `<img src="${artifact.ImageURL}" alt="${artifact.Name || '文物图片'}" style="max-width: 100%; height: auto; margin-bottom: 15px; border-radius: 8px;">` : ''}
                    <p><strong>年代:</strong> ${artifact.Era || '未知'}</p>
                    <p><strong>分类:</strong> ${artifact.Category || '未知'}</p>
                    <p><strong>位置:</strong> ${artifact.Location || '未知'}</p>
                    <p style="margin-top: 10px;">${artifact.Description || '暂无描述'}</p>
                    <!-- 可以添加更多详情、导览、语音讲解按钮等 -->
                `;
                cardGrid.appendChild(artifactCard);
            });

            audienceArtifactListDiv.appendChild(cardGrid); // Append the grid to the section container

            // Add click event listener to each artifact card using event delegation on the grid container
            cardGrid.addEventListener('click', function(event) {
                const clickedCard = event.target.closest('.card');
                if (clickedCard) {
                    const artifactId = clickedCard.dataset.artifactId;
                    if (artifactId) {
                        showArtifactDetails(artifactId); // Call the function to show details
                    }
                }
            });
        }

        // Placeholder function to show artifact details (New Function)
        function showArtifactDetails(artifactId) {
            console.log('Showing details for artifact ID:', artifactId);
            // Find the artifact in the loaded list
            const artifact = window.currentArtifacts.find(art => String(art.ID) === String(artifactId));
             if (artifact) {
                 // Display details in the dedicated details area
                 displaySingleArtifactDetails(artifact);
                 // Switch view from list to details
                 showArtifactDetailSection();
             } else {
                 alert('未找到该文物详情。');
             }
        }

        // Function to display a single artifact's details in the details section (New Function)
        function displaySingleArtifactDetails(artifact) {
            const detailsSection = document.getElementById('artifact-details');
            if (!detailsSection) {
                console.error('Artifact details section not found.');
                return;
            }

            // Clear previous content
            detailsSection.innerHTML = '';

            // Add content for the single artifact details
            detailsSection.innerHTML = `
                <h2>${artifact.Name || '未知文物'} 详情</h2>
                <button class="btn btn-secondary btn-sm" onclick="hideArtifactDetailSection()">返回列表</button>
                <div class="card" style="margin-top: 20px;">
                    ${artifact.ImageURL ? `<img src="${artifact.ImageURL}" alt="${artifact.Name || '文物图片'}" style="max-width: 100%; height: auto; margin-bottom: 15px; border-radius: 8px;">` : ''}
                    <p><strong>ID:</strong> ${artifact.ID || 'N/A'}</p>
                    <p><strong>分类:</strong> ${artifact.Category || '未知'}</p>
                    <p><strong>年代:</strong> ${artifact.Era || '未知'}</p>
                    <p><strong>位置:</strong> ${artifact.Location || '未知'}</p>
                    <p><strong>浏览次数:</strong> ${artifact.ViewCount || 0}</p>
                    <p style="margin-top: 10px;"><strong>描述:</strong> ${artifact.Description || '暂无描述'}</p>
                    <!-- 可以添加音频、视频、3D模型链接等 -->
                    ${artifact.AudioURL ? `<p><strong>音频导览:</strong> <a href="${artifact.AudioURL}" target="_blank">收听</a></p>` : ''}
                    ${artifact.VideoURL ? `<p><strong>视频介绍:</strong> <a href="${artifact.VideoURL}" target="_blank">观看</a></p>` : ''}
                </div>
                 <!-- TODO: Add more details, related artifacts, comments section etc. -->
            `;
        }

        // Function to show the artifact details section and hide the list (New Function)
        function showArtifactDetailSection() {
            const audienceArtifactListDiv = document.getElementById('audienceArtifactList');
            const detailsSection = document.getElementById('artifact-details');

            if (audienceArtifactListDiv) audienceArtifactListDiv.style.display = 'none';
            if (detailsSection) detailsSection.style.display = 'block'; // Show the details section
        }

        // Function to hide the artifact details section and show the list (New Function)
        function hideArtifactDetailSection() {
             const audienceArtifactListDiv = document.getElementById('audienceArtifactList');
             const detailsSection = document.getElementById('artifact-details');

             if (detailsSection) detailsSection.style.display = 'none'; // Hide the details section
             if (audienceArtifactListDiv) audienceArtifactListDiv.style.display = 'block'; // Show the list section

             // Optional: Reload the list to reflect any potential changes (e.g., view count increment)
             // loadArtifacts(); // May not be necessary if view count is updated asynchronously or not critical to see immediately
        }

        // Function to display multimedia content (New Function)
        function displayMultimediaContent(artifacts, halls) {
            console.log("Displaying multimedia content...");

            const multimediaArtifactListDiv = document.getElementById('multimediaArtifactList');
            const panoramaViewDiv = document.getElementById('panoramaView');

            if (!multimediaArtifactListDiv || !panoramaViewDiv) {
                console.error('Multimedia display areas not found.');
                return;
            }

            // --- Display Multimedia Artifacts ---
            multimediaArtifactListDiv.innerHTML = ''; // Clear previous entries

            const multimediaArtifacts = artifacts.filter(artifact => artifact.AudioURL || artifact.VideoURL);

            if (multimediaArtifacts.length === 0) {
                multimediaArtifactListDiv.innerHTML = '<p>暂无带有音频或视频的文物。</p>';
            } else {
                const list = document.createElement('ul');
                list.style.listStyle = 'none';
                list.style.padding = '0';

                multimediaArtifacts.forEach(artifact => {
                    const listItem = document.createElement('li');
                    listItem.style.marginBottom = '15px';
                    listItem.style.padding = '15px';
                    listItem.style.borderBottom = '1px solid #eee';
                    listItem.innerHTML = `
                        <h4>${artifact.Name || '未知文物'}</h4>
                        ${artifact.AudioURL ? `<p>音频导览:<br><audio controls><source src="${artifact.AudioURL}" type="audio/mpeg">您的浏览器不支持音频播放。</audio></p>` : ''}
                        ${artifact.VideoURL ? `<p>视频介绍:<br><video controls style="max-width: 100%; height: auto;"><source src="${artifact.VideoURL}" type="video/mp4">您的浏览器不支持视频播放。</video></p>` : ''}
                        <!-- 可以嵌入音频/视频播放器，或者提供链接 -->
                    `;
                    list.appendChild(listItem);
                });
                multimediaArtifactListDiv.appendChild(list);
            }

            // --- Display Panorama View ---
            panoramaViewDiv.innerHTML = ''; // Clear previous entries

            // Find the first hall with a panorama URL
            const hallWithPanorama = halls.find(hall => hall.PanoramaURL);

            if (hallWithPanorama && hallWithPanorama.PanoramaURL) {
                // Option 1: Display a link to the panorama
                panoramaViewDiv.innerHTML = `
                    <p>探索展厅全景: <a href="${hallWithPanorama.PanoramaURL}" target="_blank">${hallWithPanorama.Name || '未知展厅'} 全景</a></p>
                `;
                // Option 2: Embed the panorama using an iframe (might have cross-origin issues or require specific viewers)
                // If using a dedicated panorama viewer library, initialize it here.
                // Example iframe (may not work with all URLs):
                /*
                panoramaViewDiv.innerHTML = `
                    <iframe src="${hallWithPanorama.PanoramaURL}" style="width: 100%; height: 400px; border: none;"></iframe>
                `;
                */

            } else {
                panoramaViewDiv.innerHTML = '<p>暂无展厅全景可用。</p>';
            }
        }

        // --- 文物详情相关的JavaScript函数结束 ---

        // --- 互动社区相关的JavaScript函数 (新增) ---

        // Function to populate artifact select dropdown for Community form (New Function)
        function loadArtifactOptionsForCommunity() {
            const artifactSelect = document.getElementById('experienceArtifact');
             if (!artifactSelect) {
                  console.error('Artifact select for Community not found.');
                  return;
              }
              // 使用已加载的文物数据填充下拉菜单
              const artifacts = window.currentArtifacts || [];
              // Clear existing options except the default
              artifactSelect.innerHTML = '<option value="">-- 选择文物 --</option>';

              artifacts.forEach(artifact => {
                  const option = document.createElement('option');
                  option.value = artifact.ID; // Use artifact ID as value
                  option.textContent = artifact.Name; // Use artifact Name as text
                  artifactSelect.appendChild(option);
              });
        }

        // Function to handle submitting a new community post (New Function)
        const shareExperienceForm = document.getElementById('shareExperienceForm');
        if (shareExperienceForm) {
            shareExperienceForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                // 收集表单数据
                const postData = {
                    Content: document.getElementById('experienceContent').value,
                    ArtifactID: document.getElementById('experienceArtifact').value || null, // Get selected artifact ID, use null if none selected
                    BehaviorType: 'CommunityPost', // Specify the type as community post
                    // UserID, CreateTime, Location, Duration etc. will be handled by backend or are not applicable here
                };

                console.log('提交的心得数据:', postData);

                try {
                    // 向后端发送POST请求到用户行为接口
                    const response = await fetch('http://192.168.31.201:5000/api/user_behaviors', { // Assuming the endpoint is /api/user_behaviors
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(postData),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message || '心得分享成功！');
                        shareExperienceForm.reset(); // 清空表单
                        // After submitting, reload all user behaviors and re-display both dashboard and community views
                        await loadUserBehaviorData(); // Reload user behaviors
                        // displayCommunityPosts is called within loadUserBehaviorData
                    } else {
                        const msg = result.message || '分享心得失败';
                        alert(`分享心得失败: ${msg}`);
                        console.error('分享心得失败响应:', result);
                    }

                } catch (error) {
                    console.error('发送分享心得请求时出错:', error);
                    alert(`分享心得失败: ${error.message}`);
                }
            });
        }

        // Function to display community posts (New Function)
        function displayCommunityPosts() { // Removed parameter, will use global data
            console.log("Displaying community posts...");

            const communityPostsListDiv = document.getElementById('communityPostsList');
             if (!communityPostsListDiv) {
                  console.error('Community posts list div not found.');
                  return;
              }
            communityPostsListDiv.innerHTML = ''; // Clear previous entries

            // Filter for behaviors with BehaviorType === 'CommunityPost' from the global data
            const allBehaviors = window.currentUserBehaviors || []; // Use global data
            const communityPosts = allBehaviors.filter(item => item.BehaviorType === 'CommunityPost');

            if (communityPosts.length === 0) {
                communityPostsListDiv.innerHTML = '<p>暂无用户心得。</p>';
                return;
            }

             // Build artifact name map for displaying associated artifact
             const artifactMap = {};
             if (window.currentArtifacts) {
                 window.currentArtifacts.forEach(artifact => {
                     artifactMap[artifact.ID] = artifact.Name;
                 });
             }

            communityPosts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.classList.add('card'); // Reuse card style
                postElement.style.marginBottom = '15px';

                 // Find associated artifact name if ArtifactID exists
                 const associatedArtifactName = post.ArtifactID !== null && artifactMap[post.ArtifactID] ? ` (关联文物: ${artifactMap[post.ArtifactID]})` : '';

                postElement.innerHTML = `
                    <p><strong>用户 (ID: ${post.UserID || '未知'}):</strong> ${post.Content || '无内容'}</p>
                    <small style="color: #666;">分享时间: ${post.CreateTime ? new Date(post.CreateTime).toLocaleString() : '未知'}${associatedArtifactName}</small>
                    <!-- TODO: 可以添加点赞/评论功能 -->
                `;
                communityPostsListDiv.appendChild(postElement);
            });
        }

        // --- 互动社区相关的JavaScript函数结束 ---

        // --- 问答管理相关的JavaScript函数 (新增) ---
        // Function to load QA data from the backend API
        async function loadQAData() {
            console.log("Loading QA data...");

            const qaListDiv = document.getElementById('qaList');
             if (!qaListDiv) {
                  console.error('QA list div not found.');
                  return;
              }
              qaListDiv.innerHTML = '<p>加载中...</p>'; // Loading indicator

              try {
                  const response = await fetch('http://192.168.31.201:5000/api/qa');
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const qaItems = await response.json();

                  displayQAItems(qaItems); // 显示问答列表

              } catch (error) {
                  console.error('Error loading QA data:', error);
                  qaListDiv.innerHTML = `<p style="color: red;">加载问答数据失败: ${error.message}</p>`;
              }
        }

        // Function to display QA items (New Function)
        function displayQAItems(qaItemsToDisplay) {
            const qaListDiv = document.getElementById('qaList');
            if (!qaListDiv) { // Redundant check, but good practice
                 console.error('QA list div not found for display.');
                 return;
            }
            qaListDiv.innerHTML = ''; // Clear previous entries

            if (qaItemsToDisplay.length === 0) {
                qaListDiv.innerHTML = '<p>暂无公开问答数据。</p>';
                return;
            }

            qaItemsToDisplay.forEach(item => {
                const qaElement = document.createElement('div');
                qaElement.classList.add('card'); // Use card style for each QA item
                qaElement.style.marginBottom = '15px';
                // 根据回答类型显示不同的前缀或样式
                const answerPrefix = item.AnswerType === 'AI' ? '🤖 AI 回答:' : (item.AnswerType === 'Human' ? '👤 管理员回复:' : '答:');
                const answerStyle = item.AnswerType === 'AI' ? 'font-style: italic; color: #007bff;' : ''; // AI回答可能用斜体或不同颜色

                qaElement.innerHTML = `
                    <p><strong>问:</strong> ${item.Question || ''}</p>
                    <p><strong style="${answerStyle}">${answerPrefix}</strong> ${item.Answer || '暂无回答'}</p>
                    <small style="color: #666;">提问时间: ${item.CreateTime ? new Date(item.CreateTime).toLocaleString() : '未知'} ${item.AnswerTime ? ' | 回答时间: ' + new Date(item.AnswerTime).toLocaleString() : ''} | 赞: ${item.LikeCount || 0}</small>
                    <!-- 可以根据需要添加编辑/删除按钮等管理功能 -->
                `;

                // Add answer form if the question has no answer yet
                if (!item.Answer || item.Answer.trim() === '') {
                    qaElement.innerHTML += `
                        <div class="answer-form" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <textarea class="form-control answer-input" rows="2" placeholder="输入您的回答..."></textarea>
                            <button class="btn btn-secondary btn-sm answer-submit-btn" data-qa-id="${item.ID}" style="margin-top: 10px;">提交回答</button>
                        </div>
                    `;
                }

                qaListDiv.appendChild(qaElement);
            });

            // Add event listener for submit buttons using event delegation
            qaListDiv.addEventListener('click', async function(event) {
                const targetButton = event.target.closest('.answer-submit-btn');
                if (targetButton) {
                    const qaId = targetButton.dataset.qaId;
                    const answerInput = targetButton.parentElement.querySelector('.answer-input');
                    const answerContent = answerInput.value.trim();

                    if (answerContent) {
                        // Disable button and input while submitting
                        targetButton.disabled = true;
                        answerInput.disabled = true;
                        targetButton.textContent = '提交中...';

                        try {
                            const response = await fetch(`http://192.168.31.201:5000/api/qa/${qaId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ Answer: answerContent }),
                            });

                            const result = await response.json();

                            if (response.ok) {
                                alert(result.message || '回答提交成功！');
                                // Refresh the QA list to show the new answer
                                loadQAData();
                            } else {
                                const msg = result.message || '提交回答失败';
                                alert(`提交回答失败: ${msg}`);
                                console.error('提交回答失败响应:', result);
                                // Re-enable button and input on failure
                                targetButton.disabled = false;
                                answerInput.disabled = false;
                                targetButton.textContent = '提交回答';
                            }
                        } catch (error) {
                            console.error('发送提交回答请求时出错:', error);
                            alert(`提交回答失败: ${error.message}`);
                            // Re-enable button and input on failure
                            targetButton.disabled = false;
                            answerInput.disabled = false;
                            targetButton.textContent = '提交回答';
                        }
                    } else {
                        alert('请输入回答内容！');
                    }
                }
            });
        }

         // Function to populate artifact select dropdown for QA form (New Function)
         function loadArtifactOptionsForQA() {
             const artifactSelect = document.getElementById('questionArtifact');
              if (!artifactSelect) {
                   console.error('Artifact select for QA not found.');
                   return;
               }
               // 使用已加载的文物数据填充下拉菜单
               const artifacts = window.currentArtifacts || [];
               // Clear existing options except the default
               artifactSelect.innerHTML = '<option value="">-- 选择文物 --</option>';

               artifacts.forEach(artifact => {
                   const option = document.createElement('option');
                   option.value = artifact.ID; // Use artifact ID as value
                   option.textContent = artifact.Name; // Use artifact Name as text
                   artifactSelect.appendChild(option);
               });
         }

         // Function to handle submitting a new question (New Function)
         const askQuestionForm = document.getElementById('askQuestionForm');
          if (askQuestionForm) {
              askQuestionForm.addEventListener('submit', async function(event) {
                  event.preventDefault();

                  const questionData = {
                      Question: document.getElementById('questionText').value,
                      ArtifactID: document.getElementById('questionArtifact').value || null, // Get selected artifact ID, use null if none selected
                      // UserID, CreateTime, IsPublic, LikeCount, Answer, AnswerType, AnswerTime will be handled by backend
                  };

                   console.log('提交的问题数据:', questionData);

                  try {
                      const response = await fetch('http://192.168.31.201:5000/api/qa', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                          },
                          body: JSON.stringify(questionData),
                      });

                      const result = await response.json();

                      if (response.ok) {
                          alert(result.message || '问题提交成功！请等待管理员回复。');
                          askQuestionForm.reset(); // 清空表单
                          // 可以选择是否刷新问答列表，新提交的问题默认可能不是公开的，所以不立即刷新
                          loadQAData(); // 在成功提交后刷新列表以显示新问题
                      } else {
                          const msg = result.message || '提交问题失败';
                          alert(`提交问题失败: ${msg}`);
                          console.error('提交问题失败响应:', result);
                      }

                  } catch (error) {
                      console.error('发送提交问题请求时出错:', error);
                      alert(`提交问题失败: ${error.message}`);
                  }
              });
          }
        // --- 问答管理相关的JavaScript函数结束 ---

        // Function to display latest activities in the overview section (New Function)
        function displayLatestActivities() { // Use global currentActivities data
            console.log("Displaying latest activities...");

            const latestActivitiesListDiv = document.getElementById('latestActivitiesList');
             if (!latestActivitiesListDiv) {
                  console.error('Latest activities list div not found.');
                  return;
              }
            latestActivitiesListDiv.innerHTML = ''; // Clear previous entries

            const allActivities = window.currentActivities || [];

            if (allActivities.length === 0) {
                latestActivitiesListDiv.innerHTML = '<p>暂无活动数据。</p>';
                return;
            }

            // Filter for published activities (assuming IsPublished is a boolean/bit field)
            const publishedActivities = allActivities.filter(activity => activity.IsPublished);

            if (publishedActivities.length === 0) {
                 latestActivitiesListDiv.innerHTML = '<p>暂无已发布的活动。</p>';
                 return;
            }

            // Sort activities by creation time in descending order (newest first)
            // Assuming CreateTime is available and is a valid date string/object
            const sortedActivities = [...publishedActivities].sort((a, b) => {
                 const timeA = a.CreateTime ? new Date(a.CreateTime).getTime() : 0;
                 const timeB = b.CreateTime ? new Date(b.CreateTime).getTime() : 0;
                 return timeB - timeA; // Sort descending
            });

            // Display top N latest activities (e.g., top 3 or 5)
            const topN = 3; // Display top 3 latest activities
            const latestActivities = sortedActivities.slice(0, topN);

            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';

            latestActivities.forEach(activity => {
                const listItem = document.createElement('li');
                listItem.style.marginBottom = '10px';
                listItem.innerHTML = `<strong>${activity.Title || '未知活动'}</strong><br><small>${activity.StartTime ? new Date(activity.StartTime).toLocaleString() : '时间待定'}</small>`;
                list.appendChild(listItem);
            });

            latestActivitiesListDiv.appendChild(list);
        }

    </script>

    <!-- 新增：模拟用户角色控制和导航显示 -->
    <script>
        // Global variable to store current user role
        window.currentUserRole = null; // 'Normal' or 'Admin'

        // Function to set mock user role, hide selection, show main content, and update UI
        function selectRole(role) {
            window.currentUserRole = role;
            document.getElementById('roleSelectionArea').style.display = 'none'; // Hide role selection
            document.getElementById('mainContentArea').style.display = 'block'; // Show main content
            document.getElementById('currentRoleDisplay').textContent = `当前角色: ${role === 'Normal' ? '普通用户' : '管理员'}`;
            console.log('用户角色设置为:', role);
            updateNavigationVisibility(); // Update navigation based on selected role
            // Optionally, navigate to the default section after role selection (e.g., overview)
             showSection('overview');
        }

        // Function to update navigation menu visibility based on role
        function updateNavigationVisibility() {
            const navBtns = document.querySelectorAll('.main-nav .nav-btn');
            const normalUserSections = ['overview', 'artifact-info', 'multimedia-interaction', 'community', 'ai-qa']; // 普通用户可见的 section
            const adminSections = ['overview', 'artifact-management', 'device-management', 'activity-management', 'exhibition-hall-management', 'user-management', 'data-dashboard']; // 管理员可见的 section

            navBtns.forEach(btn => {
                const sectionId = btn.getAttribute('data-target');
                let isVisible = false;

                if (window.currentUserRole === 'Normal') {
                    if (normalUserSections.includes(sectionId)) {
                        isVisible = true;
                    }
                } else if (window.currentUserRole === 'Admin') {
                     if (adminSections.includes(sectionId)) {
                         isVisible = true;
                     }
                } else {
                     // 如果没有设置角色（不应该发生，因为有选择界面），默认不显示任何管理端内容
                     isVisible = false;
                }

                btn.style.display = isVisible ? '' : 'none';
            });
             // 确保当前显示的 section 在切换角色后仍然可见，如果不可见则切换到首页概览
             const activeBtn = document.querySelector('.main-nav .nav-btn.active');
             if (activeBtn && activeBtn.style.display === 'none'){
                  showSection('overview');
             }
        }

        // Modify the existing DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', () => {
             // Attach event listeners to navigation buttons to call showSection
             document.querySelectorAll('.main-nav .nav-btn').forEach(button => {
                 button.addEventListener('click', () => {
                     const onclickAttr = button.getAttribute('data-target');
                     if (onclickAttr) {
                         showSection(onclickAttr);
                     } else {
                         console.error('Could not extract sectionId from data-target attribute:', onclickAttr);
                         showSection('overview');
                     }
                 });
             });

             // Initial state: main content is hidden, role selection is visible
             // We don't call showSection or updateNavigationVisibility here initially.
             // These will be called after the user selects a role via selectRole().

             // Add event listener for the search input in the artifacts section
             const searchInput = document.getElementById('searchInput');
             if (searchInput) {
                 searchInput.addEventListener('input', searchArtifacts);
             }

             // Add event listener to the form's reset event to also reset editing state
             if (artifactForm) {
                  artifactForm.addEventListener('reset', resetArtifactForm);
             }

             // Add event listener to the activity form's reset event to also reset editing state
             if (activityForm) {
                  activityForm.addEventListener('reset', resetActivityForm);
             }

             // Note: Initial showSection and updateNavigationVisibility are now called from selectRole()
        });

    </script>

    <!-- 新增：重新选择身份功能 -->
    <script>
        function resetRoleSelection() {
            window.currentUserRole = null; // Reset the stored role
            document.getElementById('mainContentArea').style.display = 'none'; // Hide main content
            document.getElementById('roleSelectionArea').style.display = 'block'; // Show role selection
            // Optionally reset the current role display text
            document.getElementById('currentRoleDisplay').textContent = '当前角色: 未设置';
            console.log('重置身份选择');
        }
    </script>

    <!-- Include qrcode.js library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- JavaScript to generate QR code -->
    <script>
        // Change the event listener from DOMContentLoaded to window.onload to ensure the QRCode library is fully loaded.
        window.onload = function() {
            // Find the QR code container
            const qrcodeDiv = document.getElementById('qrcode');

            if (qrcodeDiv) {
                // Get the current page URL
                const currentPageUrl = window.location.href;

                // Generate QR code
                new QRCode(qrcodeDiv, {
                    text: currentPageUrl,
                    width: 128,
                    height: 128,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                console.log("QR code generated for URL:", currentPageUrl);
            } else {
                 console.error("QR code div not found.");
            }
        };
    </script>

</body>

</html> 